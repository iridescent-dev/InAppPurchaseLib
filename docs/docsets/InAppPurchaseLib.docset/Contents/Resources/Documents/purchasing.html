<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Purchasing  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset="utf-8">
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
    <script src="js/lunr.min.js" defer></script>
    <script src="js/typeahead.jquery.js" defer></script>
    <script src="js/jazzy.search.js" defer></script>
  </head>
  <body>


    <a title="Purchasing  Reference"></a>

    <header class="header">
      <p class="header-col header-col--primary">
        <a class="header-link" href="index.html">
          InAppPurchaseLib documentation
        </a>
         (77% documented)
      </p>
    
      <p class="header-col--secondary">
        <form role="search" action="search.json">
          <input type="text" placeholder="Search documentation" data-typeahead>
        </form>
      </p>
    
        <p class="header-col header-col--secondary">
          <a class="header-link" href="https://github.com/iridescent-dev/iap-swift-lib">
            <img class="header-icon" src="img/gh.png"/>
            View on GitHub
          </a>
        </p>
    
    </header>

    <p class="breadcrumbs">
      <a class="breadcrumb" href="index.html">InAppPurchaseLib Reference</a>
      <img class="carat" src="img/carat.png" />
      Purchasing  Reference
    </p>

    <div class="content-wrapper">
      <nav class="navigation">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Getting%20Started.html">Getting Started</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="installation.html">Installation</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="micro-example.html">Micro Example</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Usage.html">Usage</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="initialization.html">Initialization</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="displaying-products.html">Displaying products</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="displaying-subscriptions.html">Displaying subscriptions</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="refreshing.html">Refreshing</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="purchasing.html">Purchasing</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="handling-purchases.html">Handling purchases</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="restoring-purchases.html">Restoring purchases</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="displaying-products-with-purchases.html">Displaying products with purchases</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="errors.html">Errors</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="analytics.html">Analytics</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="server-integration.html">Server integration</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="API%20documentation.html">API documentation</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/InAppPurchase.html">InAppPurchase</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/InAppPurchaseLib.html">InAppPurchaseLib</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/DefaultPurchaseDelegate.html">DefaultPurchaseDelegate</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/IAPPurchaseDelegate.html">IAPPurchaseDelegate</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/IAPProduct.html">IAPProduct</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/IAPProductType.html">IAPProductType</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/SKProduct.html">SKProduct</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/IAPPeriodFormat.html">IAPPeriodFormat</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="API%20documentation.html#/s:16InAppPurchaseLib19IAPPurchaseCallbacka">IAPPurchaseCallback</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="API%20documentation.html#/s:16InAppPurchaseLib18IAPRefreshCallbacka">IAPRefreshCallback</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/IAPPurchaseResult.html">IAPPurchaseResult</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/IAPRefreshResult.html">IAPRefreshResult</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/IAPPurchaseResultState.html">IAPPurchaseResultState</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/IAPRefreshResultState.html">IAPRefreshResultState</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/IAPError.html">IAPError</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/IAPErrorCode.html">IAPErrorCode</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/IAPErrorProtocol.html">IAPErrorProtocol</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">

        <section class="section">
          <div class="section-content top-matter">
            
            <h1 id='purchasing' class='heading'>Purchasing</h1>

<p>The purchase process is generally a little bit more involving than most people would expect. Why is it not just: purchase &rarr; on success unlock the feature?</p>

<p>Several reasons:</p>

<ul>
<li>In-app purchases can be initiated outside the app</li>
<li>In-app purchases can be deferred, pending parental approval</li>
<li>Apple wants to be sure you delivered the product before charging the user</li>
</ul>

<p>That is why the process looks like so:</p>

<ul>
<li>being ready to handle purchase events from app startup</li>
<li>finalizing transactions when product delivery is complete</li>
<li>sending purchase request, for which successful doesn&rsquo;t always mean complete</li>
</ul>
<h3 id='initiating-a-purchase' class='heading'>Initiating a purchase</h3>

<p>To initiate a purchase, use the <code>InAppPurchase.purchase()</code> function. It takes the <code>productIdentifier</code> and a <code>callback</code> function, called when the purchase has been processed.</p>

<p><strong>Important</strong>: Do not process the purchase here, we&rsquo;ll handle that later!</p>

<p>From this callback, you can for example unlock the UI by hiding your loading indicator and display a message to the user.</p>

<p><em>Example:</em></p>
<pre class="highlight swift"><code><span class="k">self</span><span class="o">.</span><span class="n">loaderView</span><span class="o">.</span><span class="nf">show</span><span class="p">()</span>
<span class="kt">InAppPurchase</span><span class="o">.</span><span class="nf">purchase</span><span class="p">(</span>
  <span class="nv">productIdentifier</span><span class="p">:</span> <span class="s">"my_product_id"</span><span class="p">,</span>
  <span class="nv">callback</span><span class="p">:</span> <span class="p">{</span> <span class="n">_</span> <span class="k">in</span>
    <span class="k">self</span><span class="o">.</span><span class="n">loaderView</span><span class="o">.</span><span class="nf">hide</span><span class="p">()</span>
<span class="p">})</span>
</code></pre>

<p>This simple example locks the UI with a loader when the purchase is in progress. We&rsquo;ll see later how the purchase has to be processed by your applicaiton.</p>

<p>The callback also gives more information about the outcome of the purchase, you might want to use it to update your UI as well. Note that some events are useful for analytics. So here&rsquo;s a more complete example.</p>
<pre class="highlight swift"><code><span class="k">self</span><span class="o">.</span><span class="n">loaderView</span><span class="o">.</span><span class="nf">show</span><span class="p">()</span>
<span class="kt">InAppPurchase</span><span class="o">.</span><span class="nf">purchase</span><span class="p">(</span>
  <span class="nv">productIdentifier</span><span class="p">:</span> <span class="s">"my_product_id"</span><span class="p">,</span>
  <span class="nv">callback</span><span class="p">:</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
    <span class="k">self</span><span class="o">.</span><span class="n">loaderView</span><span class="o">.</span><span class="nf">hide</span><span class="p">()</span>

    <span class="k">switch</span> <span class="n">result</span><span class="o">.</span><span class="n">state</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">purchased</span><span class="p">:</span>
      <span class="c1">// Product successfully purchased</span>
      <span class="c1">// Reminder: Do not process the purchase here, only update your UI.</span>
      <span class="c1">//           that's why we do not send data to analytics.</span>
      <span class="nf">openThankYouScreen</span><span class="p">()</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">failed</span><span class="p">:</span>
      <span class="c1">// Purchase failed</span>
      <span class="c1">// - Human formated reason can be found in result.localizedDescription</span>
      <span class="c1">// - More details in either result.skError or result.iapError</span>
      <span class="nf">showError</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">localizedDescription</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">deferred</span><span class="p">:</span>
      <span class="c1">// The purchase is deferred, waiting for the parent's approval</span>
      <span class="nf">openWaitingParentApprovalScreen</span><span class="p">()</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">cancelled</span><span class="p">:</span>
      <span class="c1">// The user canceled the request, generally only useful for analytics.</span>
  <span class="p">}</span>
<span class="p">})</span>
</code></pre>

<p>If the purchase fails, result will contain either <code>.skError</code>, a <a href="https://developer.apple.com/documentation/storekit/skerror/code"><code>SKError</code></a> from StoreKit, or <code>.iapError</code>, an <a href="errors.html"><code><a href="Structs/IAPError.html">IAPError</a></code></a>.</p>

<p><em>Tip:</em> After a successful purchase, you should see a new transaction in <a href="https://billing-dashboard.fovea.cc/transactions">Fovea&rsquo;s dashboard</a>.</p>

          </div>
        </section>


      </article>
    </div>
    <section class="footer">
      <p>Copyright © 2020 <a class="link" href="https://iridescent.dev" target="_blank" rel="external">Iridescent</a>.</p>
      <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.13.3</a>, a <a class="link" href="https://realm.io" target="_blank" rel="external">Realm</a> project.</p>
    </section>
  </body>
</div>
</html>
