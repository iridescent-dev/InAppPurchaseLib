<!DOCTYPE html>
<html lang="en">
  <head>
    <title>InAppPurchaseLib  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset='utf-8'>
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
  </head>
  <body>
    <a title="InAppPurchaseLib  Reference"></a>
    <header>
      <div class="content-wrapper">
        <p><a href="index.html">InAppPurchaseLib</a> (52% documented)</p>
        <p class="header-right"><a href="https://github.com/iridescent-dev/iap-swift-lib"><img src="img/gh.png"/>View on GitHub</a></p>
      </div>
    </header>
    <div class="content-wrapper">
      <p id="breadcrumbs">
        <a href="index.html">InAppPurchaseLib Reference</a>
        <img id="carat" src="img/carat.png" />
        InAppPurchaseLib  Reference
      </p>
    </div>
    <div class="content-wrapper">
      <nav class="sidebar">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a href="Classes.html">Classes</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/DefaultPurchaseDelegate.html">DefaultPurchaseDelegate</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/InAppPurchase.html">InAppPurchase</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Enums.html">Enumerations</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Enums/IAPErrorCode.html">IAPErrorCode</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/IAPPeriodFormat.html">IAPPeriodFormat</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/IAPProductType.html">IAPProductType</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/IAPPurchaseResultState.html">IAPPurchaseResultState</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/IAPRefreshResultState.html">IAPRefreshResultState</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Extensions.html">Extensions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Extensions/SKProduct.html">SKProduct</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Protocols.html">Protocols</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Protocols/IAPErrorProtocol.html">IAPErrorProtocol</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/IAPPurchaseDelegate.html">IAPPurchaseDelegate</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/InAppPurchaseLib.html">InAppPurchaseLib</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Structs.html">Structures</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Structs/IAPError.html">IAPError</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/IAPProduct.html">IAPProduct</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/IAPPurchaseResult.html">IAPPurchaseResult</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/IAPRefreshResult.html">IAPRefreshResult</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Typealiases.html">Type Aliases</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Typealiases.html#/s:16InAppPurchaseLib19IAPPurchaseCallbacka">IAPPurchaseCallback</a>
              </li>
              <li class="nav-group-task">
                <a href="Typealiases.html#/s:16InAppPurchaseLib18IAPRefreshCallbacka">IAPRefreshCallback</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">
        <section>
          <section class="section">
            
            <p align="center">
  <img src="InAppPurchaseLib.png" width="640" title="InAppPurchaseLib">
</p>

<blockquote>
<p>An easy-to-use library for In-App Purchases, using Fovea.Billing for receipts validation.</p>
</blockquote>

<ul>
<li><a href="#features">Features</a></li>
<li><a href="#getting-started">Getting Started</a>

<ul>
<li><a href="#requirements">Requirements</a></li>
<li><a href="#installation">Installation</a></li>
</ul></li>
<li><a href="#usage">Usage</a>

<ul>
<li><a href="#initialization">Initialization</a></li>
<li><a href="#displaying-products">Displaying products</a></li>
<li><a href="#displaying-subscriptions">Displaying subscriptions</a></li>
<li><a href="#refreshing">Refreshing</a></li>
<li><a href="#purchasing">Purchasing</a></li>
<li><a href="#making-a-purchase">Making a purchase</a></li>
<li><a href="#processing-purchases">Processing purchases</a></li>
<li><a href="#restoring-purchases">Restoring purchases</a></li>
<li><a href="#purchased-products">Purchased products</a></li>
<li><a href="#purchases-information">Purchases information</a></li>
<li><a href="#errors">Errors</a></li>
</ul></li>
<li><a href="#server-integration">Server integration</a></li>
<li><a href="#xcode-demo-project">Xcode Demo Project</a></li>
<li><a href="#references">References</a></li>
<li><a href="#troubleshooting">Troubleshooting</a></li>
<li><a href="#license">License</a></li>
</ul>
<h1 id='features' class='heading'>Features</h1>

<ul>
<li>✅ Purchase a product</li>
<li>✅ Restore purchased products</li>
<li>✅ Verify transactions with the App Store on Fovea.Billing server</li>
<li>✅ Handle and notify payment transaction states</li>
<li>✅ Retreive products information from the App Store</li>
<li>✅ Support all product types (consumable, non-consumable, auto-renewable subscription, non-renewing subscription)</li>
<li>✅ Status of purchases available when offline</li>
<li>✅ Server integration with a Webhook</li>
</ul>
<h1 id='getting-started' class='heading'>Getting Started</h1>

<p>If you haven&rsquo;t already, I highly recommend your read the <em>Overview</em> and <em>Preparing</em> section of Apple&rsquo;s <a href="https://developer.apple.com/in-app-purchase">In-App Purchase official documentation</a></p>
<h2 id='requirements' class='heading'>Requirements</h2>

<ul>
<li>Configure your App and Xcode to support In-App Purchases.

<ul>
<li><a href="https://help.apple.com/app-store-connect/#/devb57be10e7">AppStore Connect Setup</a></li>
</ul></li>
<li>Create and configure your <a href="https://billing.fovea.cc/?ref=iap-swift-lib">Fovea.Billing</a> project account:

<ul>
<li>Set your bundle ID</li>
<li>The iOS Shared Secret (or shared key) is to be retrieved from <a href="https://appstoreconnect.apple.com/">AppStoreConnect</a></li>
<li>The iOS Subscription Status URL (only if you want subscriptions)</li>
</ul></li>
</ul>
<h2 id='installation' class='heading'>Installation</h2>

<p align="center">
  <img src="ScreenshotInstallation.png" title="Installation">
</p>

<ul>
<li>Select your project in Xcode</li>
<li>Go to the section <em>Swift Package</em></li>
<li>Click on <em>(+) Add Package Dependency</em></li>
<li>Copy the Git URL: <em><a href="https://github.com/iridescent-dev/iap-swift-lib.git">https://github.com/iridescent-dev/iap-swift-lib.git</a></em></li>
<li>Click on <em>Next</em> &gt; <em>Next</em></li>
<li>Make sure your project is selected in <em>Add to target</em></li>
<li>Click on <em>Finish</em></li>
</ul>

<p><em>Note:</em> You have to <code>import InAppPurchaseLib</code> wherever you use the library.</p>
<h1 id='usage' class='heading'>Usage</h1>

<p>The process of implementing in-app purchases involves several steps:</p>

<ol>
<li>Displaying the list of purchasable products</li>
<li>Initiating a purchase</li>
<li>Delivering and finalizing a purchase</li>
<li>Checking the current ownership of non-consumables and subscriptions</li>
<li>Implementing the Restore Purchases button</li>
</ol>
<h2 id='initialization' class='heading'>Initialization</h2>

<p>Before everything else the library must be initialized. This has to happen as soon as possible. A good way is to call the <code>InAppPurchase.initialize()</code> method when the application did finish launching. In the background, this will load your products and refresh the status of purchases and subscriptions.</p>

<p><code>InAppPurchase.initialize()</code> accepts the following arguments:</p>

<ul>
<li><code>iapProducts</code> - An array of <strong>IAPProduct</strong> (REQUIRED)</li>
<li><code>validatorUrlString</code> - The validator url retrieved from <a href="https://billing.fovea.cc/?ref=iap-swift-lib">Fovea</a> (REQUIRED)</li>
<li><code>applicationUsername</code> - The user name, if your app implements user login (optional)</li>
</ul>

<p>Each <strong>IAPProduct</strong> contains the following fields:</p>

<ul>
<li><code>productIdentifier</code> - The product unique identifier</li>
<li><code>productType</code> - The <strong>IAPProductType</strong> (<code>consumable</code>, <code>nonConsumable</code>, <code>nonRenewingSubscription</code> or <code>autoRenewableSubscription</code>)</li>
</ul>

<p><em>Example:</em></p>

<p>A good place is generally in your application delegate&rsquo;s <code>didFinishLaunchingWithOptions</code> function, like below:</p>
<pre class="highlight swift"><code><span class="kd">import</span> <span class="kt">InAppPurchaseLib</span>

<span class="kd">class</span> <span class="kt">AppDelegate</span><span class="p">:</span> <span class="kt">UIResponder</span><span class="p">,</span> <span class="kt">UIApplicationDelegate</span><span class="p">,</span> <span class="kt">IAPPurchaseDelegate</span> <span class="p">{</span>
  <span class="o">...</span>
  <span class="kd">func</span> <span class="nf">application</span><span class="p">(</span><span class="n">_</span> <span class="nv">application</span><span class="p">:</span> <span class="kt">UIApplication</span><span class="p">,</span> <span class="n">didFinishLaunchingWithOptions</span> <span class="nv">launchOptions</span><span class="p">:</span> <span class="p">[</span><span class="kt">UIApplication</span><span class="o">.</span><span class="kt">LaunchOptionsKey</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]?)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
    <span class="kt">InAppPurchase</span><span class="o">.</span><span class="nf">initialize</span><span class="p">(</span>
      <span class="nv">iapProducts</span><span class="p">:</span> <span class="p">[</span>
        <span class="kt">IAPProduct</span><span class="p">(</span><span class="nv">productIdentifier</span><span class="p">:</span> <span class="s">"monthly_plan"</span><span class="p">,</span> <span class="nv">productType</span><span class="p">:</span> <span class="o">.</span><span class="n">autoRenewableSubscription</span><span class="p">),</span>
        <span class="kt">IAPProduct</span><span class="p">(</span><span class="nv">productIdentifier</span><span class="p">:</span> <span class="s">"yearly_plan"</span><span class="p">,</span>  <span class="nv">productType</span><span class="p">:</span> <span class="o">.</span><span class="n">autoRenewableSubscription</span><span class="p">),</span>
        <span class="kt">IAPProduct</span><span class="p">(</span><span class="nv">productIdentifier</span><span class="p">:</span> <span class="s">"disable_ads"</span><span class="p">,</span>  <span class="nv">productType</span><span class="p">:</span> <span class="o">.</span><span class="n">nonConsumable</span><span class="p">)</span>
      <span class="p">],</span>
      <span class="nv">validatorUrlString</span><span class="p">:</span> <span class="s">"https://validator.fovea.cc/v1/validate?appName=demo&amp;apiKey=12345678"</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kd">func</span> <span class="nf">productPurchased</span><span class="p">(</span><span class="nv">productIdentifier</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ... process purchase (we'll see that later)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>You should also call the <code>stop</code> method when the application will terminate, for proper cleanup.</p>
<pre class="highlight swift"><code>  <span class="kd">func</span> <span class="nf">applicationWillTerminate</span><span class="p">(</span><span class="n">_</span> <span class="nv">application</span><span class="p">:</span> <span class="kt">UIApplication</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">InAppPurchase</span><span class="o">.</span><span class="nf">stop</span><span class="p">()</span>
  <span class="p">}</span>
</code></pre>

<p>For more advanced use cases, in particular when you have implemented user login, you&rsquo;ll have to make some adjustments. We&rsquo;ll learn more about this in the <a href="#server-integration">Server integration</a> section.</p>

<p><em>Tip:</em> If initialization was successful, you should see a new receipt validation event in <a href="https://billing-dashboard.fovea.cc/events">Fovea&rsquo;s Dashboard</a>.</p>
<h2 id='displaying-products' class='heading'>Displaying products</h2>

<p>Let&rsquo;s start with the simplest case: you have a single product.</p>

<p>You can retrieve all information about this product using the function <code>InAppPurchase.getProductBy(identifier: &quot;my_product_id&quot;)</code>. This returns an <a href="https://developer.apple.com/documentation/storekit/skproduct">SKProduct</a> extended with helpful methods.</p>

<p>Those are the most important:</p>

<ul>
<li><code>productIdentifier: String</code> - The string that identifies the product to the Apple AppStore.</li>
<li><code>localizedTitle: String</code> - The name of the product, in the language of the device, as retrieved from the AppStore.</li>
<li><code>localizedDescription: String</code> - A description of the product, in the language of the device, as retrieved from the AppStore.</li>
<li><code>localizedPrice: String</code> - The cost of the product in the local currency (<em>read-only property added by this library</em>).</li>
</ul>

<p><em>Example</em>:</p>

<p>You can add a function similar to this to your view.</p>
<pre class="highlight swift"><code><span class="kd">@objc</span> <span class="kd">func</span> <span class="nf">refreshView</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">guard</span> <span class="k">let</span> <span class="nv">product</span><span class="p">:</span> <span class="kt">SKProduct</span> <span class="o">=</span> <span class="kt">InAppPurchase</span><span class="o">.</span><span class="nf">getProductBy</span><span class="p">(</span><span class="nv">identifier</span><span class="p">:</span> <span class="s">"my_product_id"</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">self</span><span class="o">.</span><span class="n">titleLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">"Product unavailable"</span>
    <span class="k">return</span>
  <span class="p">}</span>
  <span class="k">self</span><span class="o">.</span><span class="n">titleLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">localizedTitle</span>
  <span class="k">self</span><span class="o">.</span><span class="n">descriptionLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">localizedDescription</span>
  <span class="k">self</span><span class="o">.</span><span class="n">priceLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">localizedPrice</span>
<span class="p">}</span>
</code></pre>

<p>This example assumes <code>self.titleLabel</code> is a UILabel, etc.</p>

<p>Make sure to call this function when the view appears on screen, for instance by calling it from <a href="https://developer.apple.com/documentation/uikit/uiviewcontroller/1621510-viewwillappear"><code>viewWillAppear</code></a>.</p>
<pre class="highlight swift"><code><span class="k">override</span> <span class="kd">func</span> <span class="nf">viewWillAppear</span><span class="p">(</span><span class="n">_</span> <span class="nv">animated</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">self</span><span class="o">.</span><span class="nf">refreshView</span><span class="p">()</span>
<span class="p">}</span>
</code></pre>
<h2 id='displaying-subscriptions' class='heading'>Displaying subscriptions</h2>

<p>For subscription products, you also have some data about subscription periods and introductory offers.</p>

<ul>
<li><code>func hasIntroductoryPriceEligible() -&gt; Bool</code> - The product has an introductory price the user is eligible to.</li>
<li><code>localizedSubscriptionPeriod: String?</code> - The period of the subscription.</li>
<li><code>localizedIntroductoryPrice: String?</code> -  The cost of the introductory offer if available in the local currency.</li>
<li><code>localizedIntroductoryPeriod: String?</code> - The subscription period of the introductory offer.</li>
<li><code>localizedIntroductoryDuration: String?</code> - The duration of the introductory offer.</li>
</ul>

<p><strong>Example</strong></p>
<pre class="highlight swift"><code><span class="kd">@objc</span> <span class="kd">func</span> <span class="nf">refreshView</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">guard</span> <span class="k">let</span> <span class="nv">product</span><span class="p">:</span> <span class="kt">SKProduct</span> <span class="o">=</span> <span class="kt">InAppPurchase</span><span class="o">.</span><span class="nf">getProductBy</span><span class="p">(</span><span class="nv">identifier</span><span class="p">:</span> <span class="s">"my_product_id"</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">self</span><span class="o">.</span><span class="n">titleLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">"Product unavailable"</span>
    <span class="k">return</span>
  <span class="p">}</span>
  <span class="k">self</span><span class="o">.</span><span class="n">titleLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">localizedTitle</span>
  <span class="k">self</span><span class="o">.</span><span class="n">descriptionLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">localizedDescription</span>

  <span class="c1">// Format price text. Example: "0,99€ / month for 3 months (then 3,99 € / month)"</span>
  <span class="k">var</span> <span class="nv">priceText</span> <span class="o">=</span> <span class="s">"</span><span class="se">\(</span><span class="n">product</span><span class="o">.</span><span class="n">localizedPrice</span><span class="se">)</span><span class="s"> / </span><span class="se">\(</span><span class="n">product</span><span class="o">.</span><span class="n">localizedSubscriptionPeriod</span><span class="o">!</span><span class="se">)</span><span class="s">"</span>
  <span class="k">if</span> <span class="n">product</span><span class="o">.</span><span class="nf">hasIntroductoryPriceEligible</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="n">product</span><span class="o">.</span><span class="n">introductoryPrice</span><span class="o">!.</span><span class="n">numberOfPeriods</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
          <span class="n">priceText</span> <span class="o">=</span> <span class="s">"</span><span class="se">\(</span><span class="n">product</span><span class="o">.</span><span class="n">localizedIntroductoryPrice</span><span class="o">!</span><span class="se">)</span><span class="s"> for </span><span class="se">\(</span><span class="n">product</span><span class="o">.</span><span class="n">localizedIntroductoryDuration</span><span class="o">!</span><span class="se">)</span><span class="s">"</span> <span class="o">+</span>
          <span class="s">" (then </span><span class="se">\(</span><span class="n">priceText</span><span class="se">)</span><span class="s">)"</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">priceText</span> <span class="o">=</span> <span class="s">"</span><span class="se">\(</span><span class="n">product</span><span class="o">.</span><span class="n">localizedIntroductoryPrice</span><span class="o">!</span><span class="se">)</span><span class="s"> / </span><span class="se">\(</span><span class="n">product</span><span class="o">.</span><span class="n">localizedIntroductoryPeriod</span><span class="o">!</span><span class="se">)</span><span class="s">"</span> <span class="o">+</span>
          <span class="s">" for </span><span class="se">\(</span><span class="n">product</span><span class="o">.</span><span class="n">localizedIntroductoryDuration</span><span class="o">!</span><span class="se">)</span><span class="s"> (then </span><span class="se">\(</span><span class="n">priceText</span><span class="se">)</span><span class="s">)"</span>
      <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">self</span><span class="o">.</span><span class="n">priceLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">priceText</span>
<span class="p">}</span>
</code></pre>

<p><em>Note:</em> You have to <code>import StoreKit</code> wherever you use <code>SKProduct</code>.</p>
<h2 id='refreshing' class='heading'>Refreshing</h2>

<p>Data might change or not be yet available when your &ldquo;product&rdquo; view is presented. In order to properly handle those cases, you should refresh your view after refreshing in-app products metadata. You want to be sure you&rsquo;re displaying up-to-date information.</p>

<p>To achieve this, call <code>InAppPurchase.refresh()</code> when your view is presented.</p>
<pre class="highlight swift"><code><span class="k">override</span> <span class="kd">func</span> <span class="nf">viewWillAppear</span><span class="p">(</span><span class="n">_</span> <span class="nv">animated</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">self</span><span class="o">.</span><span class="nf">refreshView</span><span class="p">()</span>
  <span class="kt">InAppPurchase</span><span class="o">.</span><span class="nf">refresh</span><span class="p">(</span><span class="nv">callback</span><span class="p">:</span> <span class="p">{</span> <span class="n">_</span> <span class="k">in</span>
      <span class="k">self</span><span class="o">.</span><span class="nf">refreshView</span><span class="p">()</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre>
<h2 id='purchasing' class='heading'>Purchasing</h2>

<p>The purchase process is generally a little bit more involving than most people would expect. Why is it not just: purchase &rarr; on success unlock the feature?</p>

<p>Several reasons:</p>

<ul>
<li>In-app purchases can be initiated outside the app</li>
<li>In-app purchases can be deferred, pending parental approval</li>
<li>Apple wants to be sure you delivered the product before charging the user</li>
</ul>

<p>That is why the process looks like so:</p>

<ul>
<li>being ready to handle purchase events from app startup</li>
<li>finalizing transactions when product delivery is complete</li>
<li>sending purchase request, for which successful doesn&rsquo;t always mean complete</li>
</ul>
<h3 id='initiating-a-purchase' class='heading'>Initiating a purchase</h3>

<p>To initiate a purchase, use the <code>InAppPurchase.purchase()</code> function. It takes the <code>productIdentifier</code> and a <code>callback</code> function, called when the purchase has been processed.</p>

<p><strong>Important</strong>: Do not process the purchase here, we&rsquo;ll handle that later!</p>

<p>From this callback, you can for example unlock the UI by hiding your loading indicator and display a message to the user.</p>

<p><em>Example:</em></p>
<pre class="highlight swift"><code><span class="k">self</span><span class="o">.</span><span class="n">loaderView</span><span class="o">.</span><span class="nf">show</span><span class="p">()</span>
<span class="kt">InAppPurchase</span><span class="o">.</span><span class="nf">purchase</span><span class="p">(</span>
  <span class="nv">productIdentifier</span><span class="p">:</span> <span class="s">"my_product_id"</span><span class="p">,</span>
  <span class="nv">callback</span><span class="p">:</span> <span class="p">{</span> <span class="n">_</span> <span class="k">in</span>
    <span class="k">self</span><span class="o">.</span><span class="n">loaderView</span><span class="o">.</span><span class="nf">hide</span><span class="p">()</span>
<span class="p">})</span>
</code></pre>

<p>This simple example locks the UI with a loader when the purchase is in progress. We&rsquo;ll see later how the purchase has to be processed by your applicaiton.</p>

<p>The callback also gives more information about the outcome of the purchase, you might want to use it to update your UI as well. Note that some events are useful for analytics. So here&rsquo;s a more complete example.</p>
<pre class="highlight swift"><code><span class="k">self</span><span class="o">.</span><span class="n">loaderView</span><span class="o">.</span><span class="nf">show</span><span class="p">()</span>
<span class="kt">InAppPurchase</span><span class="o">.</span><span class="nf">purchase</span><span class="p">(</span>
  <span class="nv">productIdentifier</span><span class="p">:</span> <span class="s">"my_product_id"</span><span class="p">,</span>
  <span class="nv">callback</span><span class="p">:</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
    <span class="k">self</span><span class="o">.</span><span class="n">loaderView</span><span class="o">.</span><span class="nf">hide</span><span class="p">()</span>

    <span class="k">switch</span> <span class="n">result</span><span class="o">.</span><span class="n">state</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">purchased</span><span class="p">:</span>
      <span class="c1">// Product successfully purchased</span>
      <span class="c1">// Reminder: Do not process the purchase here, only update your UI.</span>
      <span class="c1">//           that's why we do not send data to analytics.</span>
      <span class="nf">openThankYouScreen</span><span class="p">()</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">failed</span><span class="p">:</span>
      <span class="c1">// Purchase failed</span>
      <span class="c1">// - Human formated reason can be found in result.localizedDescription</span>
      <span class="c1">// - More details in either result.skError or result.iapError</span>
      <span class="nf">showError</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">localizedDescription</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">deferred</span><span class="p">:</span>
      <span class="c1">// The purchase is deferred, waiting for the parent's approval</span>
      <span class="nf">openWaitingParentApprovalScreen</span><span class="p">()</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">cancelled</span><span class="p">:</span>
      <span class="c1">// The user canceled the request, generally only useful for analytics.</span>
  <span class="p">}</span>
<span class="p">})</span>
</code></pre>

<p>If the purchase fails, result will contain either <code>.skError</code>, a <a href="https://developer.apple.com/documentation/storekit/skerror/code"><code>SKError</code></a> from StoreKit, or <code>.iapError</code>, an <a href="#errors"><code><a href="Structs/IAPError.html">IAPError</a></code></a>.</p>

<p><em>Tip:</em> After a successful purchase, you should see a new transaction in <a href="https://billing-dashboard.fovea.cc/transactions">Fovea&rsquo;s dashboard</a>.</p>
<h2 id='handling-purchases' class='heading'>Handling purchases</h2>

<p>Finally, the magic happened: a user purchased one of your products! Let&rsquo;s see how we handle the different types of products.</p>
<h3 id='non-consumables' class='heading'>Non-Consumables</h3>

<p>Wherever your app needs to know if a non-consumable product has been purchased, use <code>InAppPurchase.hasActivePurchase(for: 
productIdentifier)</code>. This will return true if the user currently owns the product.</p>

<p><strong>Note:</strong> The last known state for the user&rsquo;s purchases is stored as <a href="https://developer.apple.com/documentation/foundation/userdefaults">UserDefaults</a>. As such, their status is always available to your app, even when offline.</p>

<p>If you have a server that needs to know about the purchase. You should rely on Fovea&rsquo;s webhook instead of doing anything in here. We will see that later in the <a href="#server-integration">Server integration</a> section.</p>
<h3 id='auto-renewable-subscriptions' class='heading'>Auto-Renewable Subscriptions</h3>

<p>As with non-consumables, you will use <code>InAppPurchase.hasActivePurchase(for: productIdentifier)</code> to check if the user is an active subscriber to a given product.</p>

<p>You might also like to call refresh regularly, for example when entering your main view. When appropriate, the library will refresh the receipt to detect subscription renewals or expiry.</p>

<p>As we&rsquo;ve seend in the <a href="#refreshing">Refreshing</a> section:</p>
<pre class="highlight swift"><code><span class="k">override</span> <span class="kd">func</span> <span class="nf">viewWillAppear</span><span class="p">(</span><span class="n">_</span> <span class="nv">animated</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">self</span><span class="o">.</span><span class="nf">refreshView</span><span class="p">()</span>
  <span class="kt">InAppPurchase</span><span class="o">.</span><span class="nf">refresh</span><span class="p">(</span><span class="nv">callback</span><span class="p">:</span> <span class="p">{</span> <span class="n">_</span> <span class="k">in</span>
      <span class="k">self</span><span class="o">.</span><span class="nf">refreshView</span><span class="p">()</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre>

<p><strong>Note:</strong> Don&rsquo;t be reluctant to call <code>refresh()</code> often. Internally, the library ensures heavy operation are only performed if necessary: for example when a subscription just expired. So in 99% of cases this call will result in no-operations.</p>
<h3 id='consumables' class='heading'>Consumables</h3>

<p>If the purchased products in a <strong>consumable</strong>, your app is responsible for delivering the purchase then acknowlege that you&rsquo;ve done so. Delivering generally consists in increasing a counter for some sort of virtual currency. </p>

<p>Your app can be notified of a purchase at any time. So the library asks you to provide an <strong>IAPPurchaseDelegate</strong> from initialization.</p>

<p>In <code>InAppPurchase.initialize()</code>, we can pass an <strong>IAPPurchaseDelegate</strong> instance. This object implements the <strong>productPurchased(productIdentifier:)</strong> function, which is called whenever a purchase is approved.</p>

<p>Here&rsquo;s a example implementation:</p>
<pre class="highlight swift"><code><span class="kd">class</span> <span class="kt">AppDelegate</span><span class="p">:</span> <span class="kt">UIResponder</span><span class="p">,</span> <span class="kt">UIApplicationDelegate</span><span class="p">,</span> <span class="kt">IAPPurchaseDelegate</span> <span class="p">{</span>
  <span class="o">...</span>
  <span class="kd">func</span> <span class="nf">application</span><span class="p">(</span><span class="n">_</span> <span class="nv">application</span><span class="p">:</span> <span class="kt">UIApplication</span><span class="p">,</span> <span class="n">didFinishLaunchingWithOptions</span> <span class="nv">launchOptions</span><span class="p">:</span> <span class="p">[</span><span class="kt">UIApplication</span><span class="o">.</span><span class="kt">LaunchOptionsKey</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]?)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
    <span class="kt">InAppPurchase</span><span class="o">.</span><span class="nf">initialize</span><span class="p">(</span>
      <span class="nv">iapProducts</span><span class="p">:</span> <span class="p">[</span><span class="o">...</span><span class="p">],</span>
      <span class="nv">iapPurchaseDelegate</span><span class="p">:</span> <span class="k">self</span><span class="p">,</span> <span class="c1">// ADDED: iapPurchaseDelegate</span>
      <span class="nv">validatorUrlString</span><span class="p">:</span> <span class="s">"https://validator.fovea.cc/v1/validate?appName=demo&amp;apiKey=12345678"</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="c1">// IAPPurchaseDelegate implementation</span>
  <span class="kd">func</span> <span class="nf">productPurchased</span><span class="p">(</span><span class="nv">productIdentifier</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// TODO</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>It&rsquo;s also important to know that when a purchase is approved, money isn&rsquo;t yet to reach your bank account. You have to acknowledge delivery of the (virtual) item to finalize the transaction. That is why we have to call <code>InAppPurchase.finishTransactions(for: productIdentifier)</code> as soon as we delivered the product.</p>

<p><strong>Example</strong></p>

<p>Let&rsquo;s define a class that adopts the <strong>IAPPurchaseDelegate</strong> protocol, it can very well be your application delegate.</p>
<pre class="highlight swift"><code><span class="kd">func</span> <span class="nf">productPurchased</span><span class="p">(</span><span class="nv">productIdentifier</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="n">productIdenfier</span> <span class="p">{</span>
  <span class="k">case</span> <span class="s">"10_silver"</span><span class="p">:</span>
    <span class="nf">addSilver</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
  <span class="k">case</span> <span class="s">"100_silver"</span><span class="p">:</span>
    <span class="nf">addSilver</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="kt">InAppPurchase</span><span class="o">.</span><span class="nf">finishTransactions</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">productIdentifier</span><span class="p">)</span>
  <span class="kt">Analytics</span><span class="o">.</span><span class="nf">trackEvent</span><span class="p">(</span><span class="s">"purchase succeeded"</span><span class="p">,</span> <span class="n">productIdentifier</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>Here, we implement our own unlocking logic and call <code>InAppPurchase.finishTransactions()</code> afterward (assuming <code>addSilver</code> is synchronous).</p>

<p><em>Note:</em> <code>productPurchased</code> is called when a purchase has been confirmed by Fovea&rsquo;s receipt validator. If you have a server, he probably already has been notified of this purchase using the webhook.</p>

<p><strong>Reminder</strong>: Keep in mind that purchase notifications might occur even if you never called the <code>InAppPurchase.purchase()</code> function: purchases can be made from another device or the AppStore, they can be approved by parents when the app isn&rsquo;t running, purchase flows can be interupted, etc. The pattern above ensures your app is always ready to handle purchase events.</p>
<h3 id='non-renewing-subscriptions' class='heading'>Non-Renewing Subscriptions</h3>

<p>For non-renewing subscriptions, delivering consists in increasing the amount of time a user can access a given feature. Apple doesn&rsquo;t manage the length and expiry of non-renewing subscriptions: you have to do this yourself, as for consumables.</p>

<p>Basically, everything is identical to consumables.</p>
<h2 id='restoring-purchases' class='heading'>Restoring purchases</h2>

<p>Except if you only sell consumable products, Apple requires that you provide a &ldquo;Restore Purchases&rdquo; button to your users. In general, it is found in your application settings.</p>

<p>Call this method when this button is pressed.</p>
<pre class="highlight swift"><code><span class="kd">@IBAction</span> <span class="kd">func</span> <span class="nf">restorePurchases</span><span class="p">(</span><span class="n">_</span> <span class="nv">sender</span><span class="p">:</span> <span class="kt">Any</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">self</span><span class="o">.</span><span class="n">loaderView</span><span class="o">.</span><span class="nf">show</span><span class="p">()</span>
  <span class="kt">InAppPurchase</span><span class="o">.</span><span class="nf">restorePurchases</span><span class="p">(</span><span class="nv">callback</span><span class="p">:</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
      <span class="k">self</span><span class="o">.</span><span class="n">loaderView</span><span class="o">.</span><span class="nf">hide</span><span class="p">()</span>
      <span class="k">switch</span> <span class="n">result</span><span class="o">.</span><span class="n">state</span> <span class="p">{</span>
      <span class="k">case</span> <span class="o">.</span><span class="nv">succeeded</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">addedPurchases</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
              <span class="nf">print</span><span class="p">(</span><span class="s">"Restore purchases successful."</span><span class="p">)</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="nf">print</span><span class="p">(</span><span class="s">"No purchase to restore."</span><span class="p">)</span>
          <span class="p">}</span>
      <span class="k">case</span> <span class="o">.</span><span class="nv">failed</span><span class="p">:</span>
          <span class="nf">print</span><span class="p">(</span><span class="s">"Restore purchases failed."</span><span class="p">)</span>
      <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre>

<p>The <code>callback</code> method is called once the operation is complete. You can use it to unlock the UI, by hiding your loader for example, and display the adapted message to the user.</p>
<h2 id='displaying-products-with-purchases' class='heading'>Displaying products with purchases</h2>

<p>In your store screen, where you present your products titles and prices with a purchase button, there are some cases to handle that we skipped. Owned products and deferred purchases.</p>
<h3 id='owned-products' class='heading'>Owned products</h3>

<p>Non-consumables and active auto-renewing subscriptions cannot be purchased again. You should adjust your UI to reflect that state. Refer to <code>InAppPurchase.hasActivePurchase()</code> to and to the example later in this section.</p>
<h3 id='deferred-purchases' class='heading'>Deferred purchases</h3>

<p>Apple&rsquo;s <strong>Ask to Buy</strong> feature lets parents approve any purchases initiated by children, including in-app purchases.</p>

<p>With <strong>Ask to Buy</strong> enabled, when a child requests to make a purchase, the app is notified that the purchase is awaiting the parent’s approval in the purchase callback:</p>
<pre class="highlight swift"><code><span class="kt">InAppPurchase</span><span class="o">.</span><span class="nf">purchase</span><span class="p">(</span>
  <span class="nv">productIdentifier</span><span class="p">:</span> <span class="n">productIdentifier</span><span class="p">,</span>
  <span class="nv">callback</span><span class="p">:</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
    <span class="k">switch</span> <span class="n">result</span><span class="o">.</span><span class="n">state</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">deferred</span><span class="p">:</span>
      <span class="c1">// Pending parent approval</span>
  <span class="p">}</span>
<span class="p">})</span>
</code></pre>

<p>In the <em>deferred</em> case, the child has been notified by StoreKit that the parents have to approve the purchase. He might then close the app and come back later. You don&rsquo;t have much to do, but to display in your UI that there is a purchase waiting for parental approval in your views.</p>

<p>We will use the <code>hasDeferredTransaction</code> method:</p>
<pre class="highlight swift"><code><span class="kt">InAppPurchase</span><span class="o">.</span><span class="nf">hasDeferredTransaction</span><span class="p">(</span><span class="k">for</span> <span class="nv">productIdentifier</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span>
</code></pre>
<h3 id='example' class='heading'>Example</h3>

<p>Here&rsquo;s an example that covers what has been discussed above. We will update our example <code>refreshView</code> function from before:</p>
<pre class="highlight swift"><code><span class="kd">@objc</span> <span class="kd">func</span> <span class="nf">refreshView</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">guard</span> <span class="k">let</span> <span class="nv">product</span><span class="p">:</span> <span class="kt">SKProduct</span> <span class="o">=</span> <span class="kt">InAppPurchase</span><span class="o">.</span><span class="nf">getProductBy</span><span class="p">(</span><span class="nv">identifier</span><span class="p">:</span> <span class="s">"my_product_id"</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">self</span><span class="o">.</span><span class="n">titleLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">"Product unavailable"</span>
    <span class="k">return</span>
  <span class="p">}</span>
  <span class="k">self</span><span class="o">.</span><span class="n">titleLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">localizedTitle</span>
  <span class="c1">// ...</span>

  <span class="c1">// "Ask to Buy" deferred purchase waiting for parent's approval</span>
  <span class="k">if</span> <span class="kt">InAppPurchase</span><span class="o">.</span><span class="nf">hasDeferredTransaction</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="s">"my_product_id"</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">self</span><span class="o">.</span><span class="n">statusLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">"Waiting for Approval..."</span>
    <span class="k">self</span><span class="o">.</span><span class="n">purchaseButton</span><span class="o">.</span><span class="n">isPointerInteractionEnabled</span> <span class="o">=</span> <span class="kc">false</span>
  <span class="p">}</span>
  <span class="c1">// "Owned" product</span>
  <span class="k">else</span> <span class="k">if</span> <span class="kt">InAppPurchase</span><span class="o">.</span><span class="nf">hasActivePurchase</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="s">"my_product_id"</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">self</span><span class="o">.</span><span class="n">statusLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">"OWNED"</span>
    <span class="k">self</span><span class="o">.</span><span class="n">purchaseButton</span><span class="o">.</span><span class="n">isPointerInteractionEnabled</span> <span class="o">=</span> <span class="kc">false</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="k">self</span><span class="o">.</span><span class="n">purchaseButton</span><span class="o">.</span><span class="n">isPointerInteractionEnabled</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>When a product is owned or has a deferred purchase, we make sure the purchase button is grayed out. We also use a status label to display some details. Of course, you are free to design your UI as you see fit.</p>
<h2 id='errors' class='heading'>Errors</h2>

<p>When calling <code>refresh()</code>, <code>purchase()</code> or <code>restorePurchases()</code>, the callback can return an <code><a href="Structs/IAPError.html">IAPError</a></code> if the state is <code>failed</code>.
Here is the list of <code><a href="Enums/IAPErrorCode.html">IAPErrorCode</a></code> you can receive:</p>

<ul>
<li><p>Errors returned by <code>refresh()</code>, <code>purchase()</code> or <code>restorePurchases()</code></p>

<ul>
<li><code>libraryNotInitialized</code> - You must call the <code>initialize</code> fuction before using the library.</li>
<li><code>bundleIdentifierInvalid</code> - The Bundle Identifier is invalid.</li>
<li><code>validatorUrlInvalid</code> - The Validator URL String is invalid.</li>
<li><code>refreshReceiptFailed</code> - Failed to refresh the App Store receipt.</li>
<li><code>validateReceiptFailed</code> - Failed to validate the App Store receipt with Fovea.</li>
<li><code>readReceiptFailed</code> - Failed to read the receipt validation.</li>
</ul></li>
<li><p>Errors returned by <code>refresh()</code></p>

<ul>
<li><code>refreshProductsFailed</code> - Failed to refresh products from the App Store.</li>
</ul></li>
<li><p>Errors returned by <code>purchase()</code></p>

<ul>
<li><code>productNotFound</code> - The product was not found on the App Store and cannot be purchased.</li>
<li><code>cannotMakePurchase</code> - The user is not allowed to authorize payments.</li>
<li><code>alreadyPurchasing</code> - A purchase is already in progress.</li>
</ul></li>
</ul>
<h2 id='analytics' class='heading'>Analytics</h2>

<p>Tracking the purchase flow is a common things in apps. Especially as it&rsquo;s core to your revenue model.</p>

<p>We can track 5 events, which step in the purchase pipeline a user reached.</p>

<ol>
<li><code>purchase initiated</code></li>
<li><code>purchase cancelled</code></li>
<li><code>purchase failed</code></li>
<li><code>purchase deferred</code></li>
<li><code>purchase succeeded</code></li>
</ol>

<p>Here&rsquo;s a quick example showing how to implement this correctly.</p>
<pre class="highlight swift"><code><span class="kd">func</span> <span class="nf">makePurchase</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">Analytics</span><span class="o">.</span><span class="nf">trackEvent</span><span class="p">(</span><span class="s">"purchase initiated"</span><span class="p">)</span>
  <span class="kt">InAppPurchase</span><span class="o">.</span><span class="nf">purchase</span><span class="p">(</span>
    <span class="nv">productIdentifier</span><span class="p">:</span> <span class="s">"my_product_id"</span><span class="p">,</span>
    <span class="nv">callback</span><span class="p">:</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
      <span class="k">switch</span> <span class="n">result</span><span class="o">.</span><span class="n">state</span> <span class="p">{</span>
      <span class="k">case</span> <span class="o">.</span><span class="nv">purchased</span><span class="p">:</span>
        <span class="c1">// Reminder: We are not processing the purchase here, only updating your UI.</span>
        <span class="c1">//           That's why we do not send an event to analytics.</span>
      <span class="k">case</span> <span class="o">.</span><span class="nv">failed</span><span class="p">:</span>
        <span class="kt">Analytics</span><span class="o">.</span><span class="nf">trackEvent</span><span class="p">(</span><span class="s">"purchase failed"</span><span class="p">)</span>
      <span class="k">case</span> <span class="o">.</span><span class="nv">deferred</span><span class="p">:</span>
        <span class="kt">Analytics</span><span class="o">.</span><span class="nf">trackEvent</span><span class="p">(</span><span class="s">"purchase deferred"</span><span class="p">)</span>
      <span class="k">case</span> <span class="o">.</span><span class="nv">cancelled</span><span class="p">:</span>
        <span class="kt">Analytics</span><span class="o">.</span><span class="nf">trackEvent</span><span class="p">(</span><span class="s">"purchase cancelled"</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="c1">// IAPPurchaseDelegate implementation</span>
<span class="kd">func</span> <span class="nf">productPurchased</span><span class="p">(</span><span class="nv">productIdentifier</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">Analytics</span><span class="o">.</span><span class="nf">trackEvent</span><span class="p">(</span><span class="s">"purchase succeeded"</span><span class="p">)</span>
  <span class="kt">InAppPurchase</span><span class="o">.</span><span class="nf">finishTransactions</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">productIdentifier</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>The important part to remember is that a purchase can occur outside your app (or be approved when the app is not running), that&rsquo;s why tracking <code>purchase succeeded</code> has to be part of the <code>productPurchased</code> delegate function.</p>

<p>Refer to the <a href="#consumables">Consumables</a> section to learn more about the <code>productPurchased</code> function.</p>
<h2 id='server-integration' class='heading'>Server integration</h2>

<p>In more advanced use cases, you have a server component. Users are logged in and you&rsquo;ll like to unlock the content for this user on your server. The safest approach is to setup a <a href="https://billing.fovea.cc/documentation/webhook/?ref=iap-swift-lib">Webhook on Fovea</a>. You&rsquo;ll receive notifications from Fovea that transaction have been processed and/or subscriptions updated.</p>

<p>The information sent from Fovea has been verified from Apple&rsquo;s server, which makes it way more trustable than information sent from your app itself.</p>

<p>To take advantage of this, you have to inform the library of your application username. This <code>applicationUsername</code> can be provided as a parameter of the <code>InAppPurchase.initialize</code> method and updated later by changing the associated property.</p>

<p><em>Example:</em></p>
<pre class="highlight swift"><code><span class="kt">InAppPurchase</span><span class="o">.</span><span class="nf">initialize</span><span class="p">(</span>
  <span class="nv">iapProducts</span><span class="p">:</span> <span class="p">[</span><span class="o">...</span><span class="p">],</span>
  <span class="nv">validatorUrlString</span><span class="p">:</span> <span class="s">"..."</span><span class="p">),</span>
  <span class="nv">applicationUsername</span><span class="p">:</span> <span class="kt">UserSession</span><span class="o">.</span><span class="nf">getUserId</span><span class="p">())</span>

<span class="c1">// later ...</span>
<span class="kt">InAppPurchase</span><span class="o">.</span><span class="n">applicationUsername</span> <span class="o">=</span> <span class="kt">UserSession</span><span class="o">.</span><span class="nf">getUserId</span><span class="p">()</span>
</code></pre>

<p>If a user account is mandatory in your app, you will want to delay calls to <code>InAppPurchase.initialize()</code> to when your user&rsquo;s session is ready.</p>

<p>Do not hesitate to <a href="mailto:support@fovea.cc">contact Fovea</a> for help.</p>
<h1 id='xcode-demo-project' class='heading'>Xcode Demo Project</h1>

<p>Do not hesitate to check the demo project available on here: <a href="https://github.com/iridescent-dev/iap-swift-lib-demo">iap-swift-lib-demo</a>.</p>
<h1 id='references' class='heading'>References</h1>

<ul>
<li><a href="https://billing.fovea.cc/iap-swift-lib/api">API documentation</a></li>
<li><a href="https://developer.apple.com/documentation/storekit/in-app_purchase">StoreKit Documentation</a></li>
</ul>
<h1 id='coding' class='heading'>Coding</h1>

<p>Generate the documentation, using <a href="https://github.com/johankool/swift-doc/tree/access-level-option">this fork</a> of swift-doc (on <code>--minimum-access-level</code> is part of the main distrib).</p>
<pre class="highlight plaintext"><code>swift-doc generate sources --module-name InAppPurchase --format html --output docs --minimum-access-level public --base-url /iap-swift-lib/
</code></pre>
<h1 id='troubleshooting' class='heading'>Troubleshooting</h1>

<p>Common issues are covered here: <a href="https://github.com/iridescent-dev/iap-swift-lib/wiki/Troubleshooting">https://github.com/iridescent-dev/iap-swift-lib/wiki/Troubleshooting</a></p>
<h1 id='license' class='heading'>License</h1>

<p>InAppPurchaseLib is open-sourced library licensed under the MIT License. See <a href="LICENSE">LICENSE</a> for details.</p>

          </section>
        </section>
        <section id="footer">
          <p>Copyright © Iridescent 2020</p>
          <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.13.3</a>, a <a class="link" href="https://realm.io" target="_blank" rel="external">Realm</a> project.</p>
        </section>
      </article>
    </div>
  </body>
</div>
</html>
